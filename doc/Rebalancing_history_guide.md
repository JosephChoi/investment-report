# 리밸런싱 내역 기능명세서

## 1. 개요
- **기능명:** 리밸런싱 내역 관리 시스템
- **목적:** 관리자가 포트폴리오별 리밸런싱 정보를 입력하고, 고객에게 개인화된 리밸런싱 정보를 제공하는 기능
- **대상 사용자:** 관리자(리밸런싱 내역 작성 및 관리), 고객(리밸런싱 내역 조회)
- **기술 스택:** Next.js, Tailwind CSS, Supabase(데이터베이스 및 스토리지)
- **관련 페이지:** 
  - 고객용: `/dashboard` (대시보드 내 리밸런싱 내역 섹션), `/rebalancing-history`
  - 관리자용: `/admin/rebalancing-history`

## 2. 기능 요구사항

### 2.1 고객용 리밸런싱 내역 조회 기능
- **파일 위치:** 
  - `app/dashboard/page.tsx` (대시보드 내 리밸런싱 내역 섹션)
  - `app/rebalancing-history/page.tsx` (리밸런싱 내역 상세 페이지)
- **기능:**
  - 본인이 보유한 포트폴리오에 해당하는 리밸런싱 내역 조회
  - 대시보드에서 예정된 리밸런싱 요약 정보 확인
  - 리밸런싱 내역 상세 페이지에서 전체 히스토리 확인
  - 리밸런싱 참조 URL 링크 확인 및 접속
- **UI 구성요소:**
  - 대시보드 내 리밸런싱 알림 카드 (연체관리 하단 위치)
  - 리밸런싱 수량 표시 (다수 계좌 보유 시 "OO개의 리밸런싱이 있습니다" 표시)
  - 리밸런싱 내역 목록 (날짜, 포트폴리오명, 코멘트 요약)
  - 상세 내용 모달
  - 참조 URL 하이퍼링크

### 2.2 관리자용 리밸런싱 내역 관리 페이지
- **파일 위치:** `app/admin/rebalancing-history/page.tsx`
- **기능:**
  - 모든 리밸런싱 내역 조회 및 필터링
  - 새로운 리밸런싱 내역 작성
  - 기존 리밸런싱 내역 수정 및 삭제
  - 특정 포트폴리오 선택
  - 리밸런싱 일자 선택 (달력 UI)
  - 코멘트 작성
  - 참조 URL 입력
- **UI 구성요소:**
  - 리밸런싱 내역 목록 테이블 (날짜, 포트폴리오명, 코멘트 요약, 참조 URL 표시)
  - 검색 및 필터링 기능 (포트폴리오, 날짜 범위)
  - 리밸런싱 내역 작성/수정 폼
  - 포트폴리오 선택 드롭다운 (기존 포트폴리오 ID에서 선택)
  - 리밸런싱 일자 선택 캘린더
  - 코멘트 입력 에디터
  - URL 입력 필드

## 3. 데이터 모델

### 3.1 리밸런싱 내역 데이터
- **테이블명:** `rebalancing_histories`
- **주요 필드:**
  - `id`: 리밸런싱 내역 고유 ID (UUID)
  - `portfolio_id`: 포트폴리오 ID (외래 키)
  - `rebalancing_date`: 리밸런싱 일자
  - `comment`: 리밸런싱 관련 코멘트 (텍스트 또는 HTML 형식)
  - `reference_url`: 참조 URL
  - `created_at`: 생성 일시
  - `updated_at`: 수정 일시
  - `created_by`: 작성자 ID (관리자)
- **API 엔드포인트:** `/api/rebalancing-histories`

### 3.2 포트폴리오-사용자 연결 데이터
- **테이블 참조:**
  - 기존 데이터베이스의 포트폴리오-사용자 관계를 활용하여 특정 포트폴리오를 보유한 사용자 식별

## 4. 컴포넌트 구조

### 4.1 공통 컴포넌트
- **날짜 선택 컴포넌트**
  - **파일 위치:** `components/date-picker.tsx`
  - **기능:**
    - 리밸런싱 일자 선택
    - 달력 UI를 통한 직관적인 날짜 선택
  - **사용 라이브러리:** React Datepicker

- **포트폴리오 선택 컴포넌트**
  - **파일 위치:** `components/portfolio-selector.tsx`
  - **기능:**
    - 기존 포트폴리오 목록에서 선택
    - 검색 및 필터링 기능
  - **사용 라이브러리:** React Select

### 4.2 페이지별 컴포넌트
- **리밸런싱 내역 목록 컴포넌트**
  - **파일 위치:** `components/rebalancing-history-list.tsx`
  - **기능:**
    - 리밸런싱 내역 목록 표시
    - 날짜별, 포트폴리오별 정렬 및 필터링
    - 페이지네이션

- **리밸런싱 내역 폼 컴포넌트**
  - **파일 위치:** `components/rebalancing-history-form.tsx`
  - **기능:**
    - 리밸런싱 내역 작성 및 수정 폼
    - 포트폴리오 선택 드롭다운
    - 리밸런싱 일자 선택 캘린더
    - 코멘트 입력 에디터
    - URL 입력 필드

- **리밸런싱 내역 상세 컴포넌트**
  - **파일 위치:** `components/rebalancing-history-detail.tsx`
  - **기능:**
    - 리밸런싱 내역 상세 정보 표시
    - 참조 URL 하이퍼링크
    - 코멘트 콘텐츠 렌더링

- **대시보드 리밸런싱 내역 섹션 컴포넌트**
  - **파일 위치:** `components/dashboard-rebalancing.tsx`
  - **기능:**
    - 대시보드에 표시될 리밸런싱 내역 요약
    - 리밸런싱 수량 표시
    - 간략한 내용 표시 및 상세 보기 링크

## 5. API 엔드포인트

### 5.1 리밸런싱 내역 API
- **GET `/api/rebalancing-histories`**
  - 모든 리밸런싱 내역 조회 (관리자용)
  - 쿼리 파라미터: `portfolio_id`, `start_date`, `end_date`, `page`, `limit`

- **GET `/api/rebalancing-histories/user`**
  - 현재 로그인한 사용자에게 해당하는 리밸런싱 내역 조회 (고객용)
  - 사용자의 포트폴리오 정보를 기반으로 필터링

- **GET `/api/rebalancing-histories/{id}`**
  - 특정 리밸런싱 내역 상세 조회

- **POST `/api/rebalancing-histories`**
  - 새로운 리밸런싱 내역 생성
  - 요청 본문: `portfolio_id`, `rebalancing_date`, `comment`, `reference_url`

- **PUT `/api/rebalancing-histories/{id}`**
  - 기존 리밸런싱 내역 수정
  - 요청 본문: `portfolio_id`, `rebalancing_date`, `comment`, `reference_url`

- **DELETE `/api/rebalancing-histories/{id}`**
  - 리밸런싱 내역 삭제

### 5.2 포트폴리오 API
- **GET `/api/portfolios`**
  - 모든 포트폴리오 목록 조회 (관리자용)

- **GET `/api/portfolios/user`**
  - 현재 로그인한 사용자가 보유한 포트폴리오 목록 조회 (고객용)

## 6. Supabase 연동

### 6.1 데이터베이스 연동
- **테이블 생성:**
  - `rebalancing_histories` 테이블 생성
  - 외래 키 제약 조건 설정 (포트폴리오 ID와 연결)

- **RLS(Row Level Security) 설정:**
  - 관리자: 모든 리밸런싱 내역에 대한 CRUD 권한
  - 고객: 본인이 보유한 포트폴리오에 해당하는 리밸런싱 내역에 대한 읽기 권한만 부여

## 7. 사용자 인터페이스 (UI/UX)

### 7.1 고객용 리밸런싱 내역 섹션 (대시보드)
- **디자인 가이드라인:**
  - 연체관리 섹션 하단에 리밸런싱 알림 카드 배치
  - 최신 리밸런싱 내역을 상단에 표시
  - 간결하고 직관적인 UI
  - 모바일 반응형 디자인

- **사용자 경험 고려사항:**
  - 다수 계좌 보유 시 통합된 알림 제공 ("OO개의 리밸런싱이 있습니다")
  - 리밸런싱 내역 상세 내용은 모달로 표시
  - 참조 URL은 새 창에서 열리도록 설정
  - 리밸런싱 일자가 경과한 경우 알림에서 자동 제거

### 7.2 고객용 리밸런싱 내역 상세 페이지
- **디자인 가이드라인:**
  - 보유한 포트폴리오별 리밸런싱 내역 분류
  - 시간순 정렬 (최신 내역 상단)
  - 리밸런싱 히스토리 타임라인 시각화
  - 모바일 반응형 디자인

- **사용자 경험 고려사항:**
  - 포트폴리오별 필터링 기능
  - 과거 리밸런싱 내역도 히스토리로 제공
  - 참조 URL 클릭 시 새 창에서 열림

### 7.3 관리자용 리밸런싱 내역 관리 페이지
- **디자인 가이드라인:**
  - 효율적인 관리를 위한 데이터 테이블 형태
  - 날짜별, 포트폴리오별 정렬 및 필터링
  - 작성/수정 폼은 모달로 구현

- **사용자 경험 고려사항:**
  - 포트폴리오 선택 UI (드롭다운)
  - 날짜 선택 UI (캘린더)
  - 코멘트 입력을 위한 에디터
  - URL 유효성 검증

## 8. 구현 현황

### 8.1 구현 예정 기능
- 리밸런싱 내역 CRUD 기능
- 포트폴리오별 내역 관리
- 일자별 리밸런싱 정보 표시
- 참조 URL 하이퍼링크 처리
- 대시보드 내 알림 기능
- 모바일 반응형 UI

### 8.2 구현 계획
- 1단계: 데이터 모델 설계 및 테이블 구축
- 2단계: API 엔드포인트 개발
- 3단계: 관리자용 페이지 구현
- 4단계: 고객용 페이지 및 대시보드 연동 구현
- 5단계: 테스트 및 최적화

## 9. 향후 개선 계획

### 9.1 단기 개선 계획 (1-2개월)
- 리밸런싱 통계 기능 추가
- 리밸런싱 알림 시스템 (이메일, 푸시 알림)
- UI/UX 개선

### 9.2 장기 개선 계획 (3-6개월)
- 리밸런싱 자동화 기능
- 리밸런싱 효과 분석 리포트
- 리밸런싱 일정 예약 기능
- 모바일 앱 연동

---

이 문서는 투자 관리 대시보드의 리밸런싱 내역 기능에 대한 명세서입니다. 마지막 업데이트: 2023.05.15 